<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="å¹³å®‰å‡ºè¡Œ">
<meta name="theme-color" content="#1a1a2e">
<title>å¹³å®‰å‡ºè¡Œ</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
html, body { height: 100%; overflow: hidden; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'PingFang SC', sans-serif;
  background: #1a1a2e;
  color: #fff;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100vh;
  user-select: none;
  -webkit-user-select: none;
}

/* Splash screen */
.splash {
  position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: #1a1a2e;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  z-index: 100;
  transition: opacity 0.8s ease, transform 0.8s ease;
}
.splash.hide {
  opacity: 0;
  transform: translateY(-30px);
  pointer-events: none;
}
.splash-emoji {
  font-size: 80px;
  animation: bounce 1s ease infinite;
  margin-bottom: 30px;
}
@keyframes bounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-15px); }
}
.splash-text {
  font-size: 22px;
  font-weight: 600;
  text-align: center;
  line-height: 1.8;
  color: #e6edf3;
  max-width: 300px;
}
.splash-sub {
  font-size: 15px;
  color: #8b949e;
  margin-top: 16px;
  text-align: center;
  line-height: 1.6;
}
.splash-heart {
  color: #f85149;
  animation: heartbeat 1.2s ease infinite;
  display: inline-block;
}
@keyframes heartbeat {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.2); }
}

/* Main UI */
.main-ui { display: none; flex-direction: column; align-items: center; justify-content: center; width: 100%; height: 100%; }
.main-ui.show { display: flex; }
.status { font-size: 18px; color: #8b949e; margin-bottom: 40px; text-align: center; line-height: 1.6; }
.status .time { color: #58a6ff; font-size: 14px; margin-top: 8px; }
.btn-container { position: relative; }
.btn {
  width: 200px; height: 200px;
  border-radius: 50%;
  border: none;
  font-size: 22px;
  font-weight: 700;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  transition: all 0.3s;
  position: relative;
  z-index: 2;
}
.btn-board {
  background: linear-gradient(135deg, #3fb950, #2ea043);
  color: #fff;
  box-shadow: 0 8px 30px rgba(63, 185, 80, 0.4);
}
.btn-alight {
  background: linear-gradient(135deg, #f85149, #da3633);
  color: #fff;
  box-shadow: 0 8px 30px rgba(248, 81, 73, 0.4);
}
.btn:active { transform: scale(0.95); }
.btn .icon { font-size: 48px; margin-bottom: 8px; }
.btn .icon img { width: 80px; height: 48px; }
.splash-emoji img { width: 120px; height: 72px; }
.btn .sub { font-size: 13px; font-weight: 400; opacity: 0.8; margin-top: 4px; }
.progress-ring {
  position: absolute;
  top: -10px; left: -10px;
  width: 220px; height: 220px;
  z-index: 1;
}
.progress-ring circle {
  fill: none;
  stroke-width: 4;
  stroke-linecap: round;
  transform: rotate(-90deg);
  transform-origin: center;
}
.progress-bg { stroke: rgba(255,255,255,0.1); }
.progress-fill { stroke: #fff; stroke-dasharray: 660; stroke-dashoffset: 660; transition: stroke-dashoffset 0.1s linear; }
.feedback {
  margin-top: 40px;
  font-size: 16px;
  min-height: 24px;
  text-align: center;
}
.feedback.success { color: #3fb950; }
.feedback.error { color: #f85149; }
.history { margin-top: 30px; font-size: 13px; color: #8b949e; text-align: center; }
.history-item { margin: 6px 0; }
.location-status { margin-top: 16px; font-size: 12px; color: #8b949e; }
.location-status .active { color: #3fb950; }
</style>
</head>
<body>

<!-- Splash Screen -->
<div class="splash" id="splash">
  <div class="splash-emoji"><img src="mazda-suv.svg" alt="car"></div>
  <div class="splash-text">
    è€å©†è¦ä¸Šè½¦äº†å˜›ï¼Ÿ<br>
    å¼€è½¦å°å¿ƒå“¦ï¼<span class="splash-heart">â¤ï¸</span>
  </div>
  <div class="splash-sub">
    åˆ°äº†åˆ«å¿˜å†æ¥è¿™ä¸ªapp<br>å‘Šè¯‰æˆ‘ä¸€ä¸‹ï¼
  </div>
</div>

<!-- Main UI -->
<div class="main-ui" id="mainUI">
  <div class="status" id="statusText">
    é•¿æŒ‰æŒ‰é’® 3 ç§’è®°å½•
    <div class="time" id="lastAction"></div>
  </div>

  <div class="btn-container">
    <svg class="progress-ring" viewBox="0 0 220 220">
      <circle class="progress-bg" cx="110" cy="110" r="105"/>
      <circle class="progress-fill" id="progressCircle" cx="110" cy="110" r="105"/>
    </svg>
    <button class="btn btn-board" id="mainBtn">
      <span class="icon" id="btnIcon">ğŸš—</span>
      <span id="btnText">ä¸Šè½¦</span>
      <span class="sub" id="btnSub">é•¿æŒ‰ 3 ç§’</span>
    </button>
  </div>

  <div class="feedback" id="feedback"></div>

  <div class="location-status" id="locStatus"></div>

  <div class="history" id="history"></div>
</div>

<script>
// Config
const BOT_TOKEN = '8041612253:AAG9PpcPThEbu1mXOLCKQy3IYJAYqMzxtmM';
const BOBBY_CHAT_ID = '8587823969';
const HOLD_DURATION = 3000;
const CIRCLE_LENGTH = 2 * Math.PI * 105;
// Location is tracked locally but only sent on board/alight or when Bobby requests

let state = localStorage.getItem('rideState') || 'idle'; // idle | onboard
let holdStart = null;
let holdTimer = null;
let progressTimer = null;
let locationWatchId = null;
let locationSendTimer = null;
let lastLocation = null;

const btn = document.getElementById('mainBtn');
const btnText = document.getElementById('btnText');
const btnIcon = document.getElementById('btnIcon');
const btnSub = document.getElementById('btnSub');
const feedback = document.getElementById('feedback');
const progressCircle = document.getElementById('progressCircle');
const lastActionEl = document.getElementById('lastAction');
const historyEl = document.getElementById('history');
const locStatus = document.getElementById('locStatus');

// === Splash Screen ===
function showSplash() {
  const splash = document.getElementById('splash');
  const mainUI = document.getElementById('mainUI');
  // Show splash for 3 seconds
  setTimeout(() => {
    splash.classList.add('hide');
    setTimeout(() => {
      splash.style.display = 'none';
      mainUI.classList.add('show');
    }, 800);
  }, 3000);
}

// === Location Tracking ===
function startLocationTracking() {
  if (!navigator.geolocation) {
    locStatus.innerHTML = 'ğŸ“ è®¾å¤‡ä¸æ”¯æŒå®šä½';
    return;
  }
  locStatus.innerHTML = 'ğŸ“ <span class="active">å®šä½è¿½è¸ªä¸­...</span>';

  locationWatchId = navigator.geolocation.watchPosition(
    (pos) => {
      lastLocation = {
        lat: pos.coords.latitude,
        lng: pos.coords.longitude,
        accuracy: pos.coords.accuracy,
        speed: pos.coords.speed,
        ts: Date.now()
      };
      locStatus.innerHTML = `ğŸ“ <span class="active">å®šä½ä¸­</span> (ç²¾åº¦ ${Math.round(lastLocation.accuracy)}m)`;
    },
    (err) => {
      locStatus.innerHTML = `ğŸ“ å®šä½å¤±è´¥: ${err.message}`;
    },
    { enableHighAccuracy: true, maximumAge: 10000 }
  );

  // Location is tracked locally, not sent automatically
}

function stopLocationTracking() {
  if (locationWatchId !== null) {
    navigator.geolocation.clearWatch(locationWatchId);
    locationWatchId = null;
  }
  if (locationSendTimer) {
    clearInterval(locationSendTimer);
    locationSendTimer = null;
  }
  locStatus.innerHTML = '';
  lastLocation = null;
}

async function sendLocation() {
  if (!lastLocation) return;
  try {
    const url = `https://api.telegram.org/bot${BOT_TOKEN}/sendLocation`;
    await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        chat_id: BOBBY_CHAT_ID,
        latitude: lastLocation.lat,
        longitude: lastLocation.lng,
        disable_notification: true
      })
    });
  } catch(e) {}
}

// === UI ===
function updateUI() {
  if (state === 'idle') {
    btn.className = 'btn btn-board';
    btnIcon.innerHTML = '<img src="mazda-suv.svg" alt="car">';
    btnText.textContent = 'ä¸Šè½¦';
    btnSub.textContent = 'é•¿æŒ‰ 3 ç§’';
    stopLocationTracking();
  } else {
    btn.className = 'btn btn-alight';
    btnIcon.innerHTML = 'ğŸ“';
    btnText.textContent = 'åˆ°äº†';
    btnSub.textContent = 'é•¿æŒ‰ 3 ç§’';
    startLocationTracking();
  }
  loadHistory();
}

function resetProgress() {
  progressCircle.style.strokeDashoffset = CIRCLE_LENGTH;
}

function startHold() {
  holdStart = Date.now();
  feedback.textContent = '';
  feedback.className = 'feedback';

  progressTimer = setInterval(() => {
    const elapsed = Date.now() - holdStart;
    const pct = Math.min(elapsed / HOLD_DURATION, 1);
    progressCircle.style.strokeDashoffset = CIRCLE_LENGTH * (1 - pct);
  }, 30);

  holdTimer = setTimeout(() => {
    clearInterval(progressTimer);
    progressCircle.style.strokeDashoffset = 0;
    triggerAction();
  }, HOLD_DURATION);
}

function cancelHold() {
  if (holdTimer) clearTimeout(holdTimer);
  if (progressTimer) clearInterval(progressTimer);
  holdTimer = null;
  progressTimer = null;
  holdStart = null;
  resetProgress();
}

async function triggerAction() {
  const now = new Date();
  const timeStr = now.toLocaleString('zh-CN', { hour: '2-digit', minute: '2-digit', hour12: false });
  const fullTime = now.toLocaleString('zh-CN');

  let message, emoji, actionLabel;

  if (state === 'idle') {
    // Board
    state = 'onboard';
    actionLabel = 'ä¸Šè½¦';
    emoji = 'ğŸš—';
    message = `ğŸš— è€å©†ä¸Šè½¦äº†\nğŸ• ${fullTime}`;

    // Try to get current location for departure
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition((pos) => {
        const url = `https://api.telegram.org/bot${BOT_TOKEN}/sendLocation`;
        fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            chat_id: BOBBY_CHAT_ID,
            latitude: pos.coords.latitude,
            longitude: pos.coords.longitude,
            disable_notification: true
          })
        }).catch(() => {});
      }, () => {}, { enableHighAccuracy: true });
    }
  } else {
    // Alight
    state = 'idle';
    actionLabel = 'åˆ°è¾¾';
    emoji = 'ğŸ“';
    message = `ğŸ“ è€å©†å·²å¹³å®‰åˆ°è¾¾ï¼\nğŸ• ${fullTime}`;

    // Send final location
    if (lastLocation) {
      try {
        const url = `https://api.telegram.org/bot${BOT_TOKEN}/sendLocation`;
        await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            chat_id: BOBBY_CHAT_ID,
            latitude: lastLocation.lat,
            longitude: lastLocation.lng,
            disable_notification: true
          })
        });
      } catch(e) {}
    }
  }

  localStorage.setItem('rideState', state);

  // Save to history
  const history = JSON.parse(localStorage.getItem('rideHistory') || '[]');
  history.unshift({ action: actionLabel, time: fullTime, emoji });
  if (history.length > 20) history.pop();
  localStorage.setItem('rideHistory', JSON.stringify(history));

  // Vibrate
  if (navigator.vibrate) navigator.vibrate([100, 50, 100]);

  // Send message to Bobby
  try {
    const url = `https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`;
    const resp = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ chat_id: BOBBY_CHAT_ID, text: message })
    });
    if (resp.ok) {
      feedback.textContent = `âœ“ å·²é€šçŸ¥ Bobby`;
      feedback.className = 'feedback success';
    } else {
      throw new Error('send failed');
    }
  } catch(e) {
    feedback.textContent = `é€šçŸ¥å‘é€å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ`;
    feedback.className = 'feedback error';
  }

  lastActionEl.textContent = `ä¸Šæ¬¡: ${actionLabel} ${timeStr}`;
  updateUI();
}

function loadHistory() {
  const history = JSON.parse(localStorage.getItem('rideHistory') || '[]');
  if (history.length === 0) { historyEl.innerHTML = ''; return; }
  const items = history.slice(0, 5).map(h =>
    `<div class="history-item">${h.emoji} ${h.action} Â· ${h.time}</div>`
  ).join('');
  historyEl.innerHTML = `<div style="margin-bottom:6px">æœ€è¿‘è®°å½•</div>${items}`;
}

// === Events ===
btn.addEventListener('touchstart', (e) => { e.preventDefault(); startHold(); });
btn.addEventListener('touchend', cancelHold);
btn.addEventListener('touchcancel', cancelHold);
btn.addEventListener('mousedown', startHold);
btn.addEventListener('mouseup', cancelHold);
btn.addEventListener('mouseleave', cancelHold);

// Restore state
const lastHist = JSON.parse(localStorage.getItem('rideHistory') || '[]');
if (lastHist.length > 0) {
  lastActionEl.textContent = `ä¸Šæ¬¡: ${lastHist[0].action} ${lastHist[0].time}`;
}

// If was onboard, resume tracking
if (state === 'onboard') {
  // Skip splash, go straight to main UI
  document.getElementById('splash').style.display = 'none';
  document.getElementById('mainUI').classList.add('show');
  updateUI();
} else {
  showSplash();
  resetProgress();
  // updateUI after splash
  setTimeout(() => updateUI(), 3800);
}
</script>
</body>
</html>
